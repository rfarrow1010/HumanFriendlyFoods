name: Validate Food Group Classifications

on:
  pull_request:
    paths:
      - 'Foods/**'
      - 'Scripts/validate_classifications.py'
      - 'Scripts/myplate_classifier.py'
  # Temporarily disabled on push to main - 54 foods need classification
  # Re-enable by uncommenting below after running: python3 Scripts/myplate_classifier.py --apply
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'Foods/**'
  #     - 'Scripts/validate_classifications.py'
  #     - 'Scripts/myplate_classifier.py'

jobs:
  validate-classifications:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Validate all foods have food group classifications
      id: validate
      run: |
        python3 Scripts/validate_classifications.py --export classification-issues.json
        
        # Check results
        UNCLASSIFIED=$(python3 -c "import json; data=json.load(open('classification-issues.json')); print(data['total_unclassified'])")
        
        echo "unclassified=$UNCLASSIFIED" >> $GITHUB_OUTPUT
        
        # Fail if any foods are unclassified
        if [ "$UNCLASSIFIED" -gt 0 ]; then
          echo "::error::Food classification validation failed - $UNCLASSIFIED foods missing classifications"
          exit 1
        fi
    
    - name: Upload validation results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: classification-issues
        path: classification-issues.json
    
    - name: Comment on PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const issues = JSON.parse(fs.readFileSync('classification-issues.json', 'utf8'));
          
          let comment = '## âŒ Food Classification Validation Failed\n\n';
          comment += `**${issues.total_unclassified} of ${issues.total_foods} foods are missing food group classifications.**\n\n`;
          comment += 'Required food groups: `vegetables`, `fruits`, `grains`, `protein`, `dairy`, `fatsAndOils`\n\n';
          
          if (issues.unclassified.length > 0) {
            comment += '### Unclassified Foods:\n\n';
            issues.unclassified.slice(0, 20).forEach(item => {
              comment += `- **${item.name}** (\`${item.file}\`)\n`;
            });
            
            if (issues.unclassified.length > 20) {
              comment += `\n... and ${issues.unclassified.length - 20} more\n`;
            }
          }
          
          comment += '\n---\n';
          comment += '### How to fix:\n\n';
          comment += '```bash\n';
          comment += 'python3 Scripts/myplate_classifier.py --apply\n';
          comment += '```\n\n';
          comment += 'Then commit and push the changes.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
